version: 2.1
orbs:
  node: circleci/node@1.1.6
jobs:
  build-test:
    docker:
      - image: cypress/base

      - image: mongo
        environment:
          MONGODB_DATABASE: beaconsproject

      - image: wurstmeister/zookeeper
      - image: wurstmeister/kafka
        environment:
          KAFKA_ADVERTISED_HOST_NAME: localhost
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_ADVERTISED_PORT: 9092
          KAFKA_PORT: 9092
          KAFKA_ZOOKEEPER_CONNECT: localhost:2181
          KAFKA_CREATE_TOPICS: "auth:1:1,client:1:1,beacon:1:1,content:1:1,logger:1:1"
  
    steps:
      - checkout
      - setup_remote_docker
      # Install Docker client to enable running commands on the remote Docker,
      # set up above.
      - run:
          name: Install Docker client
          command: |
            set -x
            if [ ! -f docker-17.03.0-ce.tgz ]; then
              curl -sLO https://download.docker.com/linux/static/stable/x86_64/docker-17.03.0-ce.tgz
            fi
            tar -xz -C /tmp -f docker-17.03.0-ce.tgz
            mv /tmp/docker/* /usr/bin
      - run: set > ".env"
      - run: npm install
      - run: sh scripts/build_back.sh $DOCKERHUB_USERNAME $PROJECT_VERSION $GIT $API_PORT
      - run: npm run build:app
      - run: npm run build:beaconer
      - run: sh scripts/run_back.sh $DOCKERHUB_USERNAME $PROJECT_VERSION $API_PORT
      - run: docker logs webserver -f
      - run: ./node_modules/.bin/wait-on http://$API_URL:$API_PORT && npm run cy:run:back
      - run: npm run test:app
      - run: npm run test:beaconer
  
  deploy-back:
    docker:
      - image: circleci/buildpack-deps:stretch
      
    steps:
      - checkout
      - run: echo "$DOCKERHUB_PASS" && echo "$DOCKERHUB_USERNAME"

workflows:
  version: 2
  build-test-deploy:
      jobs:
        - build-test
        - deploy-back:
            requires:
              - build-test
        


